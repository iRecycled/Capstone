<!doctype html>
<html lang="en">

<head>
    <title>Chat</title>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS -->
    <script type="text/javascript" src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
        crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
        crossorigin="anonymous"></script>
    <script src="script.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.concat.min.js"></script>
    <script src="checkIfUsername.js"></script>
    <script src = 'chat_engine.js'></script>
    <!-- Font Awesome JS -->
    <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/solid.js" integrity="sha384-tzzSw1/Vo+0N5UhStP3bvwWPq+uvzCMfrN1fEFe+xBmv1C/AtVX5K0uZtmcHitFZ" crossorigin="anonymous"></script>
    <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/fontawesome.js" integrity="sha384-6OIrr52G08NpOFSZdxxz1xdNSndlD4vdcf/q2myIUVO0VsqaGHJsB0RaBE01VTOY" crossorigin="anonymous"></script>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO"
    crossorigin="anonymous">
    <!-- Our Custom CSS -->
    <link rel="stylesheet" href="style.css">
    <!-- Scrollbar Custom CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.min.css">
    <script type="text/javascript">
        name = localStorage.getItem('username');

        var targetfile;
    	$(function() {
    		 chat.getState(targetfile);

    		 // watch textarea for key presses
             $("#sendie").keydown(function(event) {
                console.log("key down");
                 var key = event.which;
                 console.log(key);
                 //all keys including return.
                 if (key >= 33) {
                     console.log(key);
                     var maxLength = $(this).attr("maxlength");
                     var length = this.value.length;

                     // don't allow new content if length is maxed out
                     if (length >= maxLength) {
                         console.log("too long?");
                         event.preventDefault();
                     }
                }
            });
            // watch textarea for key presses
            $("#chatTextSubmit").mousedown(function(event) {
                console.log("key down");
                var maxLength = $('#sendie').attr("maxlength");
                var length = document.getElementById('sendie').value.length;
                // don't allow new content if length is maxed out
                if (length >= maxLength) {
                    console.log("too long?");
                    event.preventDefault();
                }
            });
    		 // watch textarea for release of key press
    		 $('#sendie').keyup(function(e) {
    		 		console.log("key up");
                    console.log(e.keyCode);
    			  if (e.keyCode == 13) {
    			    console.log("enter key");
                    var text = $(this).val();
    				var maxLength = $(this).attr("maxlength");
                    var length = text.length;
                     console.log(length);
                      console.log(maxLength);
                    // send
                    if (length <= maxLength + 1) {
                        console.log("right size");
    			        chat.send(text, name, targetfile);
    			        $(this).val("");
                    } else {
    					$(this).val(text.substring(0, maxLength));
    				}
    			  }
             });
             // watch textarea for release of key press
    		 $('#chatTextSubmit').mouseup(function(e) {
    		 		console.log("key up");
    			    console.log("enter key");
                    var text = $("#sendie").val();
    				var maxLength = $("#sendie").attr("maxlength");
                    var length = text.length;
                    console.log(length);
                    console.log(maxLength);
                    // send
                    if (length <= maxLength + 1) {
                        console.log("right size");
                        chat.send(text, name, targetfile);
                        $('#sendie').val("");
                    } else {
                        $('#sendie').val(text.substring(0, maxLength));
                    }
             });
    	});
      function load(){
        targetfile = localStorage.getItem('serverID');
        setInterval('chat.update(targetfile)',1000);
      }
      window.onload = load;

      //when the user leaves the page
      $(window).bind('beforeunload', function(){
        for(var i = 0; i < allusers.size();i++){
            if(username == allusers[i]){
                delete allusers[i];
            }
        }
      });
    </script> 
    <script>
        //returns session ID of current user name in local storage
        //also checks the username to be compatible with sessionID
        //if username != sessionID then it is sent to loginPage
        $.ajax({
           method:'post',
           dataType: "json",
           url: 'checkID.php',
           data: {username: localStorage.getItem('username')},
           success: function(data) {
                if(data!=localStorage.getItem("sessionID")){
                    window.location.href = 'http://144.13.22.61/CS458SP19/Team1/Capstone/login.html';
                }
            }
        });
    </script>
    <script>
        //runs on start of page
        //checks to see if the username is null upon startup
        //if null then change local storage values to failed login values and send back to login screen
        $.ajax({
            method:'post',
            dataType: "json",
            url: 'checkID.php',
            data: {username: localStorage.getItem('username')},
            success: function(data) {
                if(data==localStorage.getItem("sessionID")){
                    if(localStorage.getItem('username').length==0){
                        localStorage.setItem("username","oheystopmesingaround")
                        localStorage.setItem("sessionID","-1")
                        window.location.href = 'http://144.13.22.61/CS458SP19/Team1/Capstone/login.html';
                    }
                }
                else{
                    if(localStorage.getItem('username').length==0){
                        localStorage.setItem("username","oheystopmesingaround")
                        localStorage.setItem("sessionID","-1")
                        window.location.href = 'http://144.13.22.61/CS458SP19/Team1/Capstone/login.html';
                    }  
                }
            }
        });
    </script>
    <script>
      $.ajax({
         method:'post',
         dataType: "json",
         url: 'checkID.php',
         data: {username: localStorage.getItem('username')},
         success: function(data) {
            if(data==localStorage.getItem("sessionID")){
  
            }
            else{
                window.location.href = 'http://144.13.22.61/CS458SP19/Team1/Capstone/login.html';
            }
        }
      });
    </script>
</head>

<body>
<!-- Nav Bar-->
<div id="nav-template">
    <nav class="navbar navbar-expand navbar-dark bg-dark">
        <ul class="navbar-nav mr-auto">
            <a class="nav-item nav-link active" href="home.html">Home <span class="sr-only">(current)</span></a>
        </ul>

        <ul class="navbar-nav mr-auto ">
            <a class="navbar-brand mb-0 h1" href="#">TerryChat <span class="sr-only">(current)</span></a>
        </ul>

        <ul class="navbar-nav right">
            <a class="nav-item nav-link active" href="index.html" onclick="logout()">Logout <span class="sr-only">(current)</span></a>
            <script>
                function selfProfilePage(){
                    localStorage.setItem('viewInfo', localStorage.getItem("username"));
                }
            </script>
            <a class="nav-item nav-link active" href="profile_page.html" id="username" onclick='selfProfilePage()'>       
                <script>
                    document.getElementById("username").innerHTML = '<i class="fas fa-user-circle" aria-hidden="true" ></i>' + localStorage.getItem("username");
                    function selfProfilePage(){
                        localStorage.setItem('viewInfo', localStorage.getItem("username"));
                    }
                    document.getElementById("username").addEventListener('onclick',
                        function(){
                            selfProfilePage();
                        });
                </script>
            <span class="sr-only">(current)</span></a>
            
        </ul>
    </nav>
</div>

<div class="wrapper">
    <!-- Sidebar -->
    <nav id="sidebar" class="bg-dark navbar-text text-center">
        <div class="sidebar-header">
            <h4>Instant Messages</h4>
        </div>

        <ul class="list-unstyled components">
            <li class="active">        
                <a href="#friendlist" aria-expanded="true" data-toggle="collapse" class="dropdown-toggle">Friends</a>
                <ul class="collapse list-unstyled" id="friendlist">
                    <li>
                        <a href="#">User</a>
                    </li>
                </ul>
            </li>

           <div class="sidebar-bottom">
                <li>
                    <a href="#">Chats</a>
                </li>

                <li>
                    <a href="#">About</a>
                </li>
                
                <li>
                    <a href="#">Server</a>
                </li>
            </div>
        </ul>

    </nav>
    <!-- Page Content -->
    <div id="content">
        <div class="container-fluid">
            <!--Chat Output Area-->
            <div id = "chatOutput">
                <!--Table to Display Messages-->
                <table id = "chatBox">
                    <tbody id ="chatBody">

                    </tbody>
                </table>
            </div>
            <!--Chat Input Area-->
            <div id = "chatBoxInput">
                <div id = "inputContainer" class = 'input-group'>
                    <!--Chat Text Input-->
                    <textarea id ='chatTextArea' class='form-control'></textarea>
                    <div class="dropdown">
                            <button class="btn dropdown-toggle" type="button" id="chatEmoteButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                            </button>
                            <div class="dropdown-menu" aria-labelledby="dropdownMenuButton" id = "emoteDropdown">
                              
                            </div>
                          </div>
                    <!--Chat Submit Button-->
                    <div class="input-group-append">
                        <button id ='chatTextSubmit' class='btn btn-dark'>SEND</button>
                    </div>
                </div>
            </div>
            
        </div>
    </div>
</div>

<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49"
    crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy"
    crossorigin="anonymous"></script>
<script src="script.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.concat.min.js"></script>

</body>
</html>